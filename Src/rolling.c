#include "rolling.h"
#include "spi.h"

const uint8_t Disp[][8]={
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},// OFF
{0x00,0x3C,0x24,0x24,0x24,0x24,0x24,0x3C},//0
{0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x18},//1
{0x00,0x3C,0x04,0x04,0x3C,0x20,0x20,0x3C},//2
{0x00,0x3C,0x04,0x04,0x3C,0x04,0x04,0x3C},//3
{0x00,0x24,0x24,0x24,0x3C,0x04,0x04,0x04},//4
{0x00,0x3C,0x20,0x20,0x3C,0x04,0x04,0x3C},//5
{0x00,0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C},//6
{0x00,0x3C,0x04,0x04,0x04,0x04,0x04,0x04},//7
{0x00,0x3C,0x24,0x24,0x3C,0x24,0x24,0x3C},//8
{0x00,0x3C,0x24,0x24,0x3C,0x04,0x04,0x3C},//9
{0x00,0x3C,0x42,0x42,0x7E,0x42,0x42,0x42},//A
{0x00,0x7C,0x42,0x42,0x7E,0x42,0x42,0x7C},//B
{0x00,0x3E,0x40,0x40,0x40,0x40,0x40,0x3E},//C
{0x00,0x7C,0x42,0x42,0x42,0x42,0x42,0x7C},//D
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
{0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
{0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
{0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
{0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30},//J
{0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
{0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
{0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
{0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0},//N
{0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
{0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
{0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
{0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
{0x0,0x1E,0x20,0x20,0x3E,0x2,0x2,0x3C},//S
{0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8},//T
{0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
{0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
{0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0},//W
{0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41},//X
{0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8},//Y
{0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F},//Z
{0x00,0x3C,0x42,0x02,0x7E,0x42,0x42,0x3C},//a
{0x00,0x40,0x40,0x40,0x7C,0x42,0x42,0x7C},//b
{0x00,0x00,0x00,0x3C,0x40,0x40,0x40,0x3C},//c
{0x00,0x04,0x04,0x3C,0x44,0x44,0x44,0x3C},//d
{0x00,0x38,0x44,0x44,0x78,0x40,0x40,0x3C},//e
{0x00,0x1C,0x10,0x3C,0x10,0x10,0x10,0x10},//f
{0x00,0x38,0x44,0x44,0x3C,0x04,0x44,0x38},//g
{0x00,0x20,0x20,0x20,0x3C,0x24,0x24,0x24},//h
{0x00,0x18,0x00,0x18,0x18,0x18,0x18,0x18},//i
{0x00,0x08,0x00,0x08,0x08,0x08,0x28,0x18},//j
{0x00,0x20,0x20,0x20,0x28,0x30,0x30,0x28},//k
{0x00,0x10,0x10,0x10,0x10,0x10,0x10,0x18},//l
{0x00,0x3C,0x5A,0x5A,0x5A,0x5A,0x5A,0x5A},//m
{0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42},//n
{0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C},//o
{0x00,0x3C,0x42,0x42,0x7C,0x40,0x40,0x40},//p
{0x00,0x3C,0x42,0x42,0x3E,0x02,0x02,0x02},//q
{0x00,0x38,0x44,0x40,0x40,0x40,0x40,0x40},//r
{0x00,0x38,0x44,0x40,0x38,0x04,0x44,0x38},//s
{0x00,0x00,0x10,0x38,0x10,0x10,0x14,0x18},//t
{0x00,0x00,0x44,0x44,0x44,0x44,0x44,0x38},//u
{0x00,0x00,0x44,0x44,0x44,0x44,0x28,0x10},//v
{0x00,0x00,0x44,0x54,0x54,0x54,0x54,0x28},//w
{0x00,0x00,0x00,0x44,0x28,0x10,0x28,0x44},//x
{0x00,0x00,0x24,0x24,0x24,0x1C,0x04,0x18},//y
{0x00,0x00,0x00,0x3C,0x08,0x10,0x20,0x3C},//z
};

Rolling_Struct Rolling={0};

void Rolling_Init(void)
{
	Words_To_String(Rolling.String_BUF, (const uint8_t*)&"Please Enter Words");
	Words_To_String(Rolling.String, (const uint8_t*)&"Please Enter Words");
	Rolling.Rolling_point=Rolling.String[0];
}
void Rolling_Byte(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)
{
	uint16_t Send_Data[8][LED_Number]={0};
	for(uint8_t i=0; i<LED_Number; ++i)
		for(uint8_t j=0; j<8; ++j)
			Send_Data[j][i]=Combine_uint8_t( j+1, Rolling.Rolling_Data[j][i] );
	for(uint8_t i=0; i<8; ++i)
		Write_MAX7219(LED_Matrix_SPI,GPIOx,GPIO_Pin,(uint8_t*)&Send_Data[i][0], LED_Number);
	
	for(uint8_t i=0; i<LED_Number-1; ++i)
		for(uint8_t j=0; j<8; ++j)
		{
			Rolling.Rolling_Data[j][i] <<= 1;
			if( (Rolling.Rolling_Data[j][i+1]>>7)%2 == 1)
				++Rolling.Rolling_Data[j][i];
		}
	for(uint8_t i=0; i<8; ++i)
	{
		Rolling.Rolling_Data[i][LED_Number-1] <<= 1;
		if( (Disp[Rolling.Rolling_point][i]>>(7-Rolling.Rolling_cnt))%2==1 )
			++Rolling.Rolling_Data[i][LED_Number-1];
	}
	
	if(Rolling.Rolling_cnt==7)
	{
		Rolling.Rolling_cnt=0;
		if(Rolling.Roll_Num+1==Rolling.Len)
		{
			Rolling.Rolling_point=0;
			if(Rolling.ReDisplay_cnt==ReDisplay)
			{
				Rolling.ReDisplay_cnt=0;
				Rolling.Roll_Num=0;
				for(uint16_t i=0; i<Rolling.Len; ++i)
					Rolling.String[i]=Rolling.String_BUF[i];
				Rolling.Rolling_point = Rolling.String[0];
			}
			else
				++Rolling.ReDisplay_cnt;
		}
		else
		{
			++Rolling.Roll_Num;
			Rolling.Rolling_point = Rolling.String[Rolling.Roll_Num];
		}
	}
	else
	++Rolling.Rolling_cnt;
}
void Words_To_String(uint8_t *dst,const uint8_t *sourse)
{
	for(uint16_t i=0; i<Words_BUF_LEN; ++i)
	{
		if( sourse[i]=='\0' )
		{
			Rolling.Len=i;
			return;
		}
		else if( sourse[i]>='0' && sourse[i]<='9' )
			dst[i] = sourse[i]-48+Number_Offset;
		else if( sourse[i]>='A' && sourse[i]<='Z' )
			dst[i] = sourse[i]-65+Big_Letter_Offset;
		else if( sourse[i]>='a' && sourse[i]<='z' )
			dst[i] = sourse[i]-65+Small_Letter_Offset;
		else
			dst[i]=0;
	}
	Rolling.Len=Words_BUF_LEN;
}
void Interrupt_Display(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)
{
	OFF_All(GPIOx,GPIO_Pin);	//清除之前显示
	Rolling.ReDisplay_cnt=0;
	Rolling.Roll_Num=0;
	Rolling.Rolling_cnt=0;
	for(uint16_t i=0; i<Rolling.Len; ++i)
		Rolling.String[i]=Rolling.String_BUF[i];
	Rolling.Rolling_point = Rolling.String[0];
}
